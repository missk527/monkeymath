<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Math Adventure! ‚Äì Forest Quest (EN)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --ink:#004466;
    --card-bg:rgba(255,255,255,0.92);
    --accent:#ffdd57;
    --progress:#ffcc00;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    text-align:center;
    overflow-x:hidden;
    transition: background 800ms ease;
    background: linear-gradient(180deg,#ffe66d 0%, #7ec8e3 100%);
  }
  header{
    padding:14px 10px;
    font-size: clamp(22px,2.8vw,34px);
    font-weight: 800;
    letter-spacing:.5px;
    text-shadow: 0 1px 0 rgba(255,255,255,.6);
  }
  .game-container{
    width:min(860px, 92vw);
    margin: 10px auto 28px;
    background: var(--card-bg);
    border-radius: 22px;
    padding: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
    position: relative;
    overflow:hidden;
    backdrop-filter: blur(2px);
  }
  .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center}
  select, button, input[type="number"], input[type="text"]{
    font-size:16px;
    padding:10px 12px;
    border-radius:12px;
    border:none;
    outline: none;
    background:#fff;
    color:#113;
    box-shadow: 0 2px 0 rgba(0,0,0,.06);
  }
  button{
    background:var(--accent);
    color:var(--ink);
    font-weight:800;
    cursor:pointer;
    transition: transform .06s ease, box-shadow .12s ease;
  }
  button:active{ transform: translateY(1px) }
  .question{ font-size: clamp(24px,4.2vw,42px); margin:16px 0 8px }
  .character img{ width:110px; height:auto; margin:6px 0 4px }
  .score-timer{ font-size:15px; margin:6px 0 10px }
  .progress-bar{ background:#e9eef3; border-radius:16px; overflow:hidden; height:20px; margin:8px 0 12px }
  .progress-fill{ background:var(--progress); width:0%; height:100%; transition: width .25s ease }
  .encourage{ font-size:18px; color:#0b8a27; min-height:1.6em; margin:8px 0 }
  .badges{ margin-top: 6px }
  .badge{ font-size:26px; margin:0 3px }
  .hint{ font-size:13px; opacity:.75 }

  .toggle{
    display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:10px; background:#fff;
    box-shadow: 0 2px 0 rgba(0,0,0,.06);
  }

  /* Confetti */
  .confetti{
    position:absolute; width:10px; height:10px; top:0; left:50%; opacity:.85; border-radius:2px;
    animation: fall 1.5s linear forwards;
  }
  @keyframes fall{ to{ transform: translateY(520px) rotate(360deg); opacity:0 } }

  /* Leaderboard */
  .leaderboard{ margin-top:16px; text-align:left }
  .leaderboard h3{ text-align:center; margin:8px 0 }
  .leaderboard table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden }
  .leaderboard th,.leaderboard td{ padding:8px; border-bottom:1px solid #eee; text-align:center; font-size:14px }
  .leaderboard thead th{ background:#f6f8fb; font-weight:800 }

  /* Scene Toast */
  .scene-toast{
    position:absolute; left:50%; top:10px; transform:translateX(-50%) translateY(-20px);
    background: rgba(0,0,0,.65); color:#fff; padding:8px 14px; border-radius:999px;
    font-size:14px; opacity:0; transition: all .35s ease; pointer-events:none;
  }
  .scene-toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

  /* Forest Adventure Backgrounds */
  body.scene-0{ background:
      radial-gradient(80% 60% at 50% 0%, rgba(255,255,255,.6), transparent 60%),
      linear-gradient(180deg, #fff6ad 0%, #9ed9ed 100%); }
  body.scene-1{ background:
      radial-gradient(100% 60% at 50% 0%, rgba(255,255,255,.5), transparent 60%),
      linear-gradient(180deg, #f7ffb0 0%, #7bd3e6 100%); }
  body.scene-2{ background:
      radial-gradient(90% 60% at 50% 0%, rgba(255,255,255,.45), transparent 60%),
      linear-gradient(180deg, #d0f5a0 0%, #66c6df 100%); }
  body.scene-3{ background:
      radial-gradient(80% 60% at 50% 0%, rgba(255,255,255,.35), transparent 60%),
      linear-gradient(180deg, #b4e68e 0%, #54bada 100%); }
  body.scene-4{ background:
      radial-gradient(70% 60% at 50% 0%, rgba(255,255,255,.25), transparent 60%),
      linear-gradient(180deg, #9bd67c 0%, #44b0d4 100%); }

  /* Decorative tree line */
  .tree-line{ position:absolute; inset:auto 0 0 0; height:54px; pointer-events:none; }
  .tree-line svg{ width:100%; height:100%; display:block; opacity:.25 }

  @media (max-width:480px){
    .character img{ width:92px }
    .row{gap:6px}
  }
</style>
</head>
<body class="scene-0">
  <header>Math Adventure! üêæ ‚Äî Forest Quest</header>

  <div class="game-container" id="gameCard">
    <!-- Controls -->
    <div class="row" style="margin-bottom:6px">
      <label>Mode:</label>
      <select id="gameMode" aria-label="Mode">
        <option value="single">Single Player</option>
        <option value="twoTimed">Two Players ‚Äì Timed</option>
        <option value="twoInfinite">Two Players ‚Äì Infinite</option>
      </select>

      <span class="toggle" id="evenToggleWrap" title="Multiplication only">
        <input type="checkbox" id="evenOnly" />
        <label for="evenOnly" style="user-select:none;cursor:pointer">Even multipliers only</label>
      </span>
    </div>

    <div class="row" id="playerInputs">
      <label>Player 1:</label>
      <input type="text" id="player1Name" placeholder="Enter name" />
      <label>Player 2:</label>
      <input type="text" id="player2Name" placeholder="Enter name" />
    </div>

    <div class="row">
      <label>Operation:</label>
      <select id="operation">
        <option value="add">Addition</option>
        <option value="sub">Subtraction</option>
        <option value="mul">Multiplication</option>
        <option value="div">Division</option>
      </select>

      <label>Difficulty:</label>
      <select id="difficulty" title="For + and ‚àí">
        <option value="easy">Easy (1-digit)</option>
        <option value="medium">Medium (2-digit)</option>
        <option value="hard">Hard (3-digit)</option>
      </select>

      <label>Time (timed modes):</label>
      <select id="timeLimit">
        <option value="60">1 min</option>
        <option value="120">2 min</option>
        <option value="300">5 min</option>
      </select>
    </div>

    <div class="row">
      <button id="startBtn">Start Game</button>
    </div>

    <!-- Character -->
    <div class="character" id="character">
      <img src="https://i.ibb.co/hyTn2Tt/rabbit.png" alt="Character">
    </div>

    <!-- HUD -->
    <div class="score-timer">
      <span id="playerTurnLabel"></span><br/>
      ‚ù§Ô∏è P1 Lives: <span id="p1LivesDisplay">3</span> |
      ‚ù§Ô∏è P2 Lives: <span id="p2LivesDisplay">3</span><br/>
      ‚è≥ Time: <span id="timeDisplay">0</span>s |
      ‚≠ê P1: <span id="p1ScoreDisplay">0</span> |
      ‚≠ê P2: <span id="p2ScoreDisplay">0</span>
    </div>

    <!-- Progress -->
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

    <!-- Q/A -->
    <div class="question" id="question">Press Start!</div>
    <div class="row">
      <input type="number" id="answer" placeholder="Your answer" />
      <button id="submitBtn">Submit</button>
    </div>
    <div class="encourage" id="encourage"></div>
    <div class="badges" id="badges"></div>
    <div class="hint">
      Addition/Subtraction: choose 1-, 2-, or 3-digit numbers.
      Multiplication/Division: factors 1‚Äì15. If ‚ÄúEven‚Äù is on, multipliers are 2,4,6,8,10,12,14.
    </div>

    <!-- Leaderboard -->
    <div class="leaderboard">
      <h3>üèÜ Leaderboard (Top 10)</h3>
      <table>
        <thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>

    <!-- Scene toast -->
    <div class="scene-toast" id="sceneToast">Entering the Meadow üåº</div>

    <!-- Decorative treeline -->
    <div class="tree-line">
      <svg viewBox="0 0 1200 100" preserveAspectRatio="none">
        <path d="M0,90 C120,80 180,60 240,80 C300,100 360,70 420,85 C480,100 540,72 600,88 C660,104 720,70 780,86 C840,102 900,72 960,86 C1020,100 1080,80 1140,90 L1200,100 L0,100 Z" fill="#2e7d32"/>
      </svg>
    </div>
  </div>

<script>
/* ===== DOM ===== */
const opEl = document.getElementById('operation');
const diffEl = document.getElementById('difficulty');
const timeLimitEl = document.getElementById('timeLimit');
const startBtn = document.getElementById('startBtn');
const submitBtn = document.getElementById('submitBtn');
const questionEl = document.getElementById('question');
const answerEl = document.getElementById('answer');
const encourageEl = document.getElementById('encourage');
const progressFill = document.getElementById('progressFill');
const timeDisplay = document.getElementById('timeDisplay');
const p1ScoreDisplay = document.getElementById('p1ScoreDisplay');
const p2ScoreDisplay = document.getElementById('p2ScoreDisplay');
const p1LivesDisplay = document.getElementById('p1LivesDisplay');
const p2LivesDisplay = document.getElementById('p2LivesDisplay');
const characterEl = document.getElementById('character').querySelector('img');
const badgesEl = document.getElementById('badges');
const leaderboardBody = document.getElementById('leaderboardBody');
const playerTurnLabel = document.getElementById('playerTurnLabel');
const modeEl = document.getElementById('gameMode');
const player1NameEl = document.getElementById('player1Name');
const player2NameEl = document.getElementById('player2Name');
const evenOnlyEl = document.getElementById('evenOnly');
const evenToggleWrap = document.getElementById('evenToggleWrap');
const sceneToast = document.getElementById('sceneToast');

/* ===== State ===== */
let num1, num2, correctAnswer;
let p1Score = 0, p2Score = 0, p1Lives = 3, p2Lives = 3, timeLeft = 0, timer;
let currentPlayer = 1;
let infiniteMode = false;

const encouragements = [
  "Great job! üéâ","You're a math star! ‚≠ê","Keep going! üöÄ","Wow, super fast! ‚ö°","Fantastic! üêæ"
];
const opCharacters = {
  add: "https://i.ibb.co/hyTn2Tt/rabbit.png",
  sub: "https://i.ibb.co/fS2S3bC/cat.png",
  mul: "https://i.ibb.co/1QbHfwJ/owl.png",
  div: "https://i.ibb.co/4m0hSK0/panda.png"
};
const badgeMilestones = { 5:"ü•â", 10:"ü•à", 20:"ü•á" };

/* ===== Sounds ===== */
const soundCorrect = new Audio("https://assets.mixkit.co/sfx/download/mixkit-correct-answer-tone-2870.wav");
const soundWrong   = new Audio("https://assets.mixkit.co/sfx/download/mixkit-wrong-answer-buzz-960.wav");
const soundBadge   = new Audio("https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.wav");

/* ===== Forest Scenes ===== */
const SCENES = [
  { min:0,   label:"Meadow üåº",           class:"scene-0", toast:"Entering the Meadow üåº" },
  { min:5,   label:"Forest Edge üåø",      class:"scene-1", toast:"You reached the Forest Edge üåø" },
  { min:10,  label:"Deep Forest üå≤",      class:"scene-2", toast:"Into the Deep Forest üå≤" },
  { min:15,  label:"Waterfall üíß",        class:"scene-3", toast:"You found the Waterfall üíß" },
  { min:20,  label:"Treasure Grove üíé",   class:"scene-4", toast:"Treasure Grove discovered! üíé" },
];
let currentSceneIdx = 0;

function updateSceneByScore(score){
  let idx = 0;
  for (let i=0;i<SCENES.length;i++){
    if (score >= SCENES[i].min) idx = i;
  }
  if (idx !== currentSceneIdx){
    currentSceneIdx = idx;
    document.body.className = SCENES[idx].class;
    sceneToast.textContent = SCENES[idx].toast;
    sceneToast.classList.add('show');
    setTimeout(()=>sceneToast.classList.remove('show'), 1800);
  }
}

/* ===== Helpers ===== */
const randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;

function generateQuestion(){
  let min, max;
  if (opEl.value==='mul' || opEl.value==='div'){ min=1; max=15; }
  else{
    if (diffEl.value==='easy'){min=1;max=9}
    else if (diffEl.value==='medium'){min=10;max=99}
    else {min=100;max=999}
  }

  num1 = randInt(min,max);

  if (opEl.value==='mul'){
    if (evenOnlyEl.checked){
      const evens=[2,4,6,8,10,12,14];
      num2 = evens[randInt(0,evens.length-1)];
    } else {
      num2 = randInt(min,max);
    }
  } else if (opEl.value==='div'){
    num2 = randInt(1,15);            // divisor 1..15
    num1 = num2 * randInt(1,15);     // ensure whole-number result
  } else {
    num2 = randInt(min,max);
    if (opEl.value==='sub' && num1 < num2) [num1,num2] = [num2,num1];
  }

  switch(opEl.value){
    case 'add': correctAnswer=num1+num2; questionEl.textContent=`${num1} + ${num2} = ?`; break;
    case 'sub': correctAnswer=num1-num2; questionEl.textContent=`${num1} ‚àí ${num2} = ?`; break;
    case 'mul': correctAnswer=num1*num2; questionEl.textContent=`${num1} √ó ${num2} = ?`; break;
    case 'div': correctAnswer=num1/num2; questionEl.textContent=`${num1} √∑ ${num2} = ?`; break;
  }
  characterEl.src = opCharacters[opEl.value];

  if (modeEl.value!=="single"){
    const name = currentPlayer===1 ? (player1NameEl.value||"Player 1") : (player2NameEl.value||"Player 2");
    playerTurnLabel.textContent = `üéØ ${name}'s turn`;
  } else {
    playerTurnLabel.textContent = "";
  }
}

function createConfetti(){
  for (let i=0;i<20;i++){
    const c=document.createElement('div');
    c.className='confetti';
    c.style.left = `${50 + (Math.random()*40 - 20)}%`;
    c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
    c.style.transform = `rotate(${Math.random()*360}deg)`;
    document.getElementById('gameCard').appendChild(c);
    setTimeout(()=>c.remove(), 1500);
  }
}

function checkBadges(score){
  if (badgeMilestones[score]){
    const b = document.createElement('span');
    b.className='badge';
    b.textContent = badgeMilestones[score];
    badgesEl.appendChild(b);
    soundBadge.play();
  }
}

function saveScore(name, score){
  name = name || "Player";
  let lb = JSON.parse(localStorage.getItem('mathLeaderboard')||"[]");
  lb.push({name, score});
  lb.sort((a,b)=>b.score-a.score);
  lb = lb.slice(0,10);
  localStorage.setItem('mathLeaderboard', JSON.stringify(lb));
}

function loadLeaderboard(){
  const lb = JSON.parse(localStorage.getItem('mathLeaderboard')||"[]");
  leaderboardBody.innerHTML = lb.map((e,i)=>`<tr><td>${i+1}</td><td>${e.name}</td><td>${e.score}</td></tr>`).join('');
}

/* ===== Game Flow ===== */
function startGame(){
  if (modeEl.value==='single' && !player1NameEl.value.trim()){
    alert("Please enter Player 1's name."); return;
  }
  if (modeEl.value!=='single' && (!player1NameEl.value.trim() || !player2NameEl.value.trim())){
    alert("Please enter both player names."); return;
  }

  p1Score=p2Score=0; p1Lives=p2Lives=3; currentPlayer=1;
  p1ScoreDisplay.textContent=p1Score; p2ScoreDisplay.textContent=p2Score;
  p1LivesDisplay.textContent=p1Lives; p2LivesDisplay.textContent=p2Lives;
  badgesEl.innerHTML = "";
  encourageEl.textContent = "";
  progressFill.style.width = "0%";
  document.body.className = ""; // reset then set via update
  currentSceneIdx = -1;
  updateSceneByScore(0);

  infiniteMode = (modeEl.value==='twoInfinite');
  if (infiniteMode){
    timeDisplay.textContent = "‚àû";
    clearInterval(timer);
  }else{
    timeLeft = parseInt(timeLimitEl.value);
    timeDisplay.textContent = timeLeft;
    clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft--;
      timeDisplay.textContent = timeLeft;
      if (timeLeft<=0){ clearInterval(timer); endGame(); }
    },1000);
  }
  generateQuestion();
  answerEl.focus();
}

function submitAnswer(){
  const userAns = parseInt(answerEl.value);
  if (!Number.isFinite(userAns)) return;

  if (userAns === correctAnswer){
    if (modeEl.value==='single' || currentPlayer===1){ p1Score++; p1ScoreDisplay.textContent=p1Score; checkBadges(p1Score); }
    else { p2Score++; p2ScoreDisplay.textContent=p2Score; checkBadges(p2Score); }

    const curScore = (modeEl.value==='single'||currentPlayer===1)?p1Score:p2Score;
    progressFill.style.width = ((curScore%10)*10) + "%";
    encourageEl.textContent = encouragements[Math.floor(Math.random()*encouragements.length)];
    createConfetti(); soundCorrect.play();

    const leading = Math.max(p1Score, p2Score);
    updateSceneByScore(leading);

  } else {
    encourageEl.textContent = "Oops! Try again! üí™";
    soundWrong.play();
    if (infiniteMode){
      if (currentPlayer===1){ p1Lives--; p1LivesDisplay.textContent=p1Lives; if (p1Lives<=0) return endGame(); }
      else { p2Lives--; p2LivesDisplay.textContent=p2Lives; if (p2Lives<=0) return endGame(); }
    }
  }

  answerEl.value = "";
  if (modeEl.value!=='single'){ currentPlayer = (currentPlayer===1)?2:1; }
  if (infiniteMode || timeLeft>0) generateQuestion();
}

function endGame(){
  questionEl.textContent = "Game Over!";
  let msg="";
  if (modeEl.value==='single'){
    msg = `${player1NameEl.value} scored ${p1Score} points!`;
    saveScore(player1NameEl.value, p1Score);
  } else {
    if (p1Score>p2Score) msg = `üèÜ ${player1NameEl.value} wins!`;
    else if (p2Score>p1Score) msg = `üèÜ ${player2NameEl.value} wins!`;
    else msg = "ü§ù It's a tie!";
    saveScore(player1NameEl.value, p1Score);
    saveScore(player2NameEl.value, p2Score);
  }
  encourageEl.textContent = msg;
  loadLeaderboard();
}

/* ===== Events ===== */
startBtn.addEventListener('click', startGame);
submitBtn.addEventListener('click', submitAnswer);
answerEl.addEventListener('keypress', e=>{ if (e.key==='Enter') submitAnswer(); });

function refreshEvenToggle(){ evenToggleWrap.style.display = (opEl.value==='mul') ? 'inline-flex' : 'none'; }
opEl.addEventListener('change', refreshEvenToggle);
refreshEvenToggle();

loadLeaderboard();
</script>
</body>
</html>
